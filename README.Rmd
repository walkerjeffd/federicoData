---
output:
  md_document:
    variant: gfm
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# faahydro

<!-- badges: start -->
<!-- badges: end -->

faahydro is an R package for fetching, processing, and analyzing hydrologic and 
water quality data. This package was created to support work in South Florida
by Federico & Associates, Inc.

## Installation

This package is currently only available on github. Use the `devtools::install_github()` function
to install it:

``` r
# install.packages("devtools")
devtools::install_github("walkerjeffd/faahydro")
```

Then load the package

```{r load}
library(faahydro)
```

## DBHYDRO Data

### Fetching Data

The `dbhydro_get_*()` functions are used to fetch hydrologic and water quality data from DBHYDRO.
These functions call the respective `get_*()` functions from the `dbhydroR` package,
and then perform some additional cleaning of the dataset (e.g., parsing dates, removing duplicate columns).

```{r dbhydro-get, eval = FALSE}
dbhydro_get_hydro(
  dbkeys = "91599",
  date_min = "2019-10-01",
  date_max = "2019-10-31"
)
dbhydro_get_wq(
  station_ids = "LOX3",
  date_min = "2019-09-01",
  date_max = "2019-10-31",
  test_name = "PHOSPHATE, TOTAL AS P"
)
```

Due to API limits on DBHYDRO, it is sometimes necessary to fetch data in batches using the `dbhydro_batch_get_*()` functions.

```{r dbhydro-batch-get, eval = FALSE}
dbhydro_batch_get_hydro(
  dbkeys = c("91599", "91473", "91663"),
  date_min = "2019-10-01",
  date_max = "2019-10-31",
  batch_size = 2
)
dbhydro_batch_get_wq(
  station_ids = c("LOX3", "LOX4", "LOX5"),
  date_min = "2019-09-01",
  date_max = "2019-10-31",
  test_name = "PHOSPHATE, TOTAL AS P",
  batch_size = 2
)
```

### Cleaning Data

The `dbhydro_clean_*()` functions can be used to clean the DBHYDRO datasets. This must be done before these datasets can be inserted into the database.

```{r dbhydro-clean, eval = FALSE}
df_hydro_raw <- dbhydro_get_hydro(
  dbkeys = c("91599", "91473", "91663"),
  date_min = "2019-10-01",
  date_max = "2019-10-31"
)
df_hydro <- dbhydro_clean_hydro(df_hydro_raw)

db_wq_raw <- dbhydro_get_wq(
  station_ids = c("LOX3", "LOX4", "LOX5"),
  date_min = "2019-09-01",
  date_max = "2019-10-31",
  test_name = "PHOSPHATE, TOTAL AS P"
)
df_wq <- dbhydro_clean_wq(df_wq_raw)
```

## Database

SQL scripts to create the database can be found in the `inst/sql` folder.

### Set Up

To set up a new database, first create it.

``` sh
createdb faadb
```

Then install the schema for each set of tables.

``` sh
psql -d faadb -f inst/sql/schema-dbhydro.sql
```

### Connecting

The `db_connect()` and `db_disconnect()` functions are simple wrappers for DBI to connect/disconnect to the database once it is created. The `password` argument to `db_connect()` can be omitted if the authentication is set in a `.pgpass` file.

```{r db-connect, eval=FALSE}
con <- db_connect(host = "localhost", dbname = "faadb", user = "me", password = "mypassword")
db_disconnect(con)
```

### Adding DBHYDRO Data

#### Stations

Use `db_add_dbhydro_stations()` to add new DBHYDRO stations to the database.

This function will fetch the station metadata from DBHYDRO, and will only succeed if the metadata for all specified stations is received. It will also only add metadata for stations that do not already exist in the database (i.e., new stations). The function returns `TRUE` if all new stations were successfully added, otherwise it returns `FALSE`.

```{r db-add-dbhydro-stations, eval=FALSE}
db_add_dbhydro_stations(con, station_ids = c("LOX3", "LOX6"))
```
