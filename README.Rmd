---
output:
  md_document:
    variant: gfm
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# faahydro

<!-- badges: start -->
<!-- badges: end -->

faahydro is an R package for fetching, processing, and analyzing hydrologic and 
water quality data. This package was created to support work in South Florida
by Federico & Associates, Inc.

## Installation

This package is currently only available on github. Use the `devtools::install_github()` function
to install it:

``` r
# install.packages("devtools")
devtools::install_github("walkerjeffd/faahydro")
```

Then load the package

```{r load}
library(faahydro)
```

## Logging

This package uses the [`logger` package](https://github.com/daroczig/logger) for logging. Set the log threshold by:

```{r log-threshold, eval=FALSE}
logger::log_threshold(logger::DEBUG, namespace = "faahydro")
```

## DBHYDRO Data

The `dbhydro_get_*()` functions are used to fetch hydrologic and water quality data from DBHYDRO.
These functions call the respective `get_*()` functions from the `dbhydroR` package,
and then perform some additional cleaning of the dataset (e.g., parsing dates, removing duplicate columns).

```{r dbhydro-get, eval = FALSE}
dbhydro_get_hydro(
  dbkeys = "91599",
  date_min = "2019-10-01",
  date_max = "2019-10-31"
)
dbhydro_get_wq(
  station_ids = "LOX3",
  wq_param = "TP",
  date_min = "2019-09-01",
  date_max = "2019-10-31"
)
```

Due to API limits on DBHYDRO, it is sometimes necessary to fetch data in batches using the `dbhydro_batch_get_*()` functions.

```{r dbhydro-batch-get, eval = FALSE}
dbhydro_batch_get_hydro(
  dbkeys = c("91599", "91473", "91663"),
  date_min = "2019-10-01",
  date_max = "2019-10-31",
  batch_size = 2
)
dbhydro_batch_get_wq(
  station_ids = c("LOX3", "LOX4", "LOX5"),
  wq_param = "TP",
  date_min = "2019-09-01",
  date_max = "2019-10-31",
  batch_size = 2
)
```

The `dbhydro_clean_*()` functions can be used to clean the DBHYDRO datasets. This must be done before these datasets can be inserted into the database.

```{r dbhydro-clean, eval = FALSE}
df_hydro_raw <- dbhydro_get_hydro(
  dbkeys = c("91599", "91473", "91663"),
  date_min = "2019-10-01",
  date_max = "2019-10-31",
  raw = TRUE
)
df_hydro <- dbhydro_clean_hydro(df_hydro_raw)

db_wq_raw <- dbhydro_get_wq(
  station_ids = c("LOX3", "LOX4", "LOX5"),
  wq_param = "TP",
  date_min = "2019-09-01",
  date_max = "2019-10-31",
  raw = TRUE
)
df_wq <- dbhydro_clean_wq(df_wq_raw)
```


## USGS Data

```{r usgs-get-stations, eval = FALSE}
usgs_get_station_metadata(station_ids = "263180080205001")
```

```{r usgs-get-dv, eval = FALSE}
usgs_get_dv(
  station_ids = "263180080205001", 
  param = "stage",
  date_min = "2018-01-01",
  date_max = "2018-02-01"
)
```


## Database

SQL scripts to create the database can be found in the `inst/sql` folder.

### Set Up

To set up a new database, first create it.

``` sh
createdb faadb
```

Then install the schema for each set of tables.

``` sh
psql -d faadb -f inst/sql/schema-dbhydro.sql
psql -d faadb -f inst/sql/schema-tracker.sql
psql -d faadb -f inst/sql/schema-usace.sql
psql -d faadb -f inst/sql/schema-usgs.sql
```


### Connecting

The `db_connect()` and `db_disconnect()` functions are simple wrappers for DBI to connect/disconnect to the database once it is created. The `password` argument to `db_connect()` can be omitted if the authentication is set in a `.pgpass` file.

```{r db-connect, eval=FALSE}
con <- db_connect(host = "localhost", dbname = "faadb", user = "me", password = "mypassword")
db_disconnect(con)
```


### DBHYDRO Datasets

#### Stations

Use `db_add_dbhydro_stations()` to add new DBHYDRO stations to the database.

This function will fetch the station metadata from DBHYDRO, and will only succeed if the metadata for all specified stations is received. It will also only add metadata for stations that do not already exist in the database (i.e., new stations). The function returns `TRUE` if all new stations were successfully added, otherwise it returns `FALSE`.

```{r db-add-dbhydro-stations, eval=FALSE}
db_add_dbhydro_stations(con, station_ids = c("LOX3", "LOX6"))
```

Use `db_get_dbhydro_stations()` to get stations from the database.

```{r db-get-dbhydro-stations, eval=FALSE}
db_get_dbhydro_stations(con)
```

#### DBKEYs

Use `db_add_dbhydro_dbkeys()` to add new DBHYDRO DBKEYs to the database.

This function will fetch the DBKEY metadata from DBHYDRO, and will only succeed if the metadata for all specified DBKEYs is received. It will also only add metadata for DBKEYs that do not already exist in the database (i.e., new DBKEYs). The function returns `TRUE` if all new DBKEYs were successfully added, otherwise it returns `FALSE`. It also adds any stations corresponding to the new DBKEYs, which don't already exist in the database.

```{r db-add-dbhydro-dbkeys, eval=FALSE}
db_add_dbhydro_dbkeys(con, dbkeys = c("91473", "91599"))
```

Use `db_get_dbhydro_dbkeys()` to get metadata for DBKEYs from database.

```{r db-get-dbhydro-dbkeys, eval=FALSE}
db_get_dbhydro_dbkeys(con) # get all DBKEYs
db_get_dbhydro_dbkeys(con, dbkeys = c("91473", "91599")) # get specific DBKEYs
db_get_dbhydro_dbkeys(con, dbkeys = c("91473", "91599"), include_stations = TRUE) # include station metadata
```

#### Hydrologic Data

After fetching data from DBHYDRO, use `db_update_dbhydro_hydro()` to update those records in the database. This function will update records that already exist but have a new revision date, and add any records that do not already exist.

```{r db-update-dbhydro-hydro, eval=FALSE}
# first fetch the data (must be in 'cleaned' form)
df <- dbhydro_get_hydro(dbkeys = c("91473", "91599"), date_min = "2019-10-01", date_max = "2019-11-30", raw = FALSE)
db_update_dbhydro_hydro(con, df)
```

Use `db_get_dbhydro_hydro()` to fetch hydrologic data from the database.

```{r db-get-dbhydro-hydro, eval=FALSE}
db_get_dbhydro_hydro(con, dbkeys = c("91473", "91599")) # all data
db_get_dbhydro_hydro(con, dbkeys = c("91473", "91599"), date_min = "2019-10-01") # all dates after date_min
db_get_dbhydro_hydro(con, dbkeys = c("91473", "91599"), date_min = "2019-10-01", date_max = "2019-11-30") # all dates between date_min and date_max
```

#### Water Quality Data

After fetching data from DBHYDRO, use `db_update_dbhydro_wq()` to insert/update those records in the database.

```{r db-update-dbhydro-wq, eval=FALSE}
# first fetch the data (must be in 'cleaned' form)
df <- dbhydro_get_wq(station_ids = c("LOX3", "LOX6"), date_min = "2019-01-01", date_max = "2019-11-30")
db_update_dbhydro_wq(con, df)
```

Use `db_get_dbhydro_wq()` to fetch water quality data from the database.

```{r db-get-dbhydro-wq, eval=FALSE}
db_get_dbhydro_wq(con, station_ids = c("LOX3", "LOX6")) # all dates and parameters
db_get_dbhydro_wq(con, station_ids = c("LOX3", "LOX6"), date_min = "2019-01-01", date_max = "2019-11-30") # specific date range, all parameters
db_get_dbhydro_wq(con, station_ids = c("LOX3", "LOX6"), wq_param = "TP") # specific parameter, all dates
```

### USACE Preliminary Water Quality Data

Use `db_update_usace_wq()` to load a new version of the USACE Preliminary WQ dataset.

```{r db-update-usace-wq, eval=FALSE}
df_xlsx <- readxl::read_xlsx("~/Dropbox/Work/federico/fscl/srs-tracker/prelim data/Preliminary WQ Data LIMS WCA3A and South_20191104.xlsx")
df <- df_xlsx %>% 
  janitor::clean_names() %>% 
  dplyr::rename(
    station_id = station,
    collection_date = collect_date,
    sample_type_new = sample_type,
    collection_method = collect_method,
    sample_comments = samp_comment,
    result_comments = result_comment
  ) %>% 
  dplyr::select(-report_date) %>% 
  dplyr::mutate(
    test_name = "PHOSPHATE, TOTAL AS P",
    collection_date = lubridate::force_tz(collection_date, tzone = "US/Eastern"),
    date = lubridate::as_date(collection_date),
    first_trigger_date = lubridate::mdy_hms(first_trigger_date, tz = "US/Eastern", quiet = TRUE)
  ) %>% 
  dplyr::mutate(
    collection_date = format(lubridate::with_tz(collection_date, tzone = "UTC"), "%Y-%m-%d %H:%M:%SZ"),
    date = as.character(date),
    first_trigger_date = format(lubridate::with_tz(first_trigger_date, tzone = "UTC"), "%Y-%m-%d %H:%M:%SZ")
  )

db_update_usace_wq(con, df)
```

### USGS Daily Values Dataset

```{r db-usgs-dv, eval=FALSE}
db_add_usgs_stations(con, c("263180080205001", "263000080120001"))
db_get_usgs_stations(con)
df_usgs_dv_stage <- usgs_get_dv(station_ids = c("263180080205001", "263000080120001"), param = "stage", date_min = "2018-01-01", date_max = "2018-01-31")
db_update_usgs_dv(con, df = df_usgs_dv_stage)
```

## Trackers

### Add New Tracker

```{r tracker-add, eval=FALSE}
df_tracker_dbhydro_hydro <- tibble::tibble(
  dbkey = c("91473", "91599"),
  date_min = "2019-10-01",
  date_max = NA_character_
)
df_tracker_dbhydro_wq <- tibble::tibble(
  station_id = c("LOX3", "LOX6"),
  wq_param = "TP",
  date_min = "2019-01-01",
  date_max = NA_character_
)

tracker_add(
  con,
  id = "test-tracker",
  description = "A tracker for testing",
  dbhydro_hydro = df_tracker_dbhydro_hydro,
  dbhydro_wq = df_tracker_dbhydro_wq,
  replace = TRUE
)
```

### Remove Tracker

```{r tracker-remove, eval=FALSE}
tracker_remove(con, id = "test-tracker")
```

### Get Trackers

Use `tracker_get()` to retrieve a tracker from the database. This function returns a tibble with columns `id`, `description`, `dbhydro_hydro`, and `dbhydro_wq`. The `dbhydro_hydro` and `dbhydro_wq` columns are lists containing tibbles with the DBHYDRO dbkeys and wq stations for each tracker.

```{r tracker-get, eval=FALSE}
tracker_get(con) # get all trackers
tracker_get(con, ids = c("test-tracker")) # get specific trackers
```

### Update Trackers

Use `tracker_update()` to update the data associated with each tracker. This function in turn calls `tracker_update_dbhydro_hydro()` and `tracker_update_dbhydro_wq()` to update the hydrologic and wq datasets, respectively.

```{r tracker-update, eval=FALSE}
tracker_update(con, date_min = "2019-10-01", date_max = "2019-11-30") # update all trackers
tracker_update(con, ids = c("test-tracker"), date_min = "2019-10-01", date_max = "2019-11-30") # update specific trackers

tracker_update_dbhydro_hydro(con, ids = "test-tracker", date_min = "2019-10-01", date_max = "2019-11-30") # update only hydrologic data
tracker_update_dbhydro_wq(con, ids = "test-tracker", date_min = "2019-10-01", date_max = "2019-11-30") # update only wq data
```

### Tracker Data

Use `tracker_data()` to fetch all data for a single tracker over a specified period.

```{r tracker-data, eval=FALSE}
tracker_data(con, id = "test-tracker") # all data
tracker_data(con, id = "test-tracker", date_min = "2018-10-01", date_max = "2019-09-30") # specific period
````
